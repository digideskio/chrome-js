<!DOCTYPE html>
<html>
  <head>
    <title>Chrome repl</title>
    <style type=text/css>
    body {width: 100%; height:100%; margin: 0}
    .iframe1 {
      width: 100%;
      height: 50%;
      border: 0px;
      position:absolute;
      
    }
    .iframe2 {
      width: 100%;
      height: 50%;

      border: 0px;      
      position:absolute;
      bottom:0px;            
    }
    </style>
    <script src="lib/jquery.js"></script>    
  </head>
  <body>

      <iframe src="test.html" id="iframe1" class='iframe1' ></iframe>
      <iframe src="editor.html" id="iframe2" class='iframe2'></iframe>
      
      <script>      
        that = this
        if (!localStorage['index']) 
            localStorage['index'] = 0
        var gui  = require('nw.gui');
        var util = require('util') 
        win = gui.Window.get();
        var nativeMenuBar = new gui.Menu({ type: "menubar" });
        try {
            nativeMenuBar.createMacBuiltin("My App", 
                {
                  hideEdit: false,
                  hideWindow: true
                });
            win.menu = nativeMenuBar;
            } catch (ex) {
                console.log(ex.message);
            }
            
        iframe2.onload = function()
         {       
            iframe = $($('.iframe2').contents())
            button = iframe.find('button')
            executionResult = iframe.find('#executionResult')
            editor = win.eval(iframe2,'editor')
            console.log(iframe.eval)
            //editor = iframe.
            
            button.on('click', function() {      
                executionResult.html('executing...')
                code = editor.getSession().getValue()
                if (code=='previous')
                    code = 'return localStorage[localStorage.index-1]'
                else if (code.indexOf('localStorage.index')==-1)
                {
                    localStorage[localStorage['index']] = code
                    localStorage['index']++
                }                
                //console.log('invoking code:' + code)
                try
                {
                    response = new Function(code).apply(that)
                    if (typeof(response) =='undefined')
                        executionResult.html('undefined')
                    else
                        if(typeof(response)=='string')
                            executionResult.html(response)
                        else
                            executionResult.html(util.inspect(response))
                }
                catch(error)
                {
                    executionResult.html('ERROR: ' + error)
                }        
            })
            //button.trigger('click')
            console.log(' hook placed for: ' + button)
            
            process.on('uncaughtException', function(err) 
            {
                executionResult.html('UNCAUGHT ERROR: ' + err)
            });
            
        }
        var show = function(value)
        {
            executionResult.html(util.inspect(value))
        }
        var view = function(value)
        {
            viewData = function(data)
            {
                $(iframe1.contentDocument).find('#code').html(data)
            }
            try
            {
                viewData(JSON.stringify(value,null, ' '))
            }
            catch(error)
            {
                viewData(util.inspect(value))
            }
        }
        </script>
  </body>
</html>

<!-- for API docs see
https://github.com/cyrus-and/chrome-remote-interface/
https://github.com/Admazely/inspector/blob/master/doc/README.md
https://github.com/admazely/inspector/blob/master/doc/DOM.md
https://developer.chrome.com/devtools/docs/protocol/1.1/index
https://developer.chrome.com/devtools/docs/protocol/1.1/dom
https://developer.chrome.com/devtools/docs/protocol/1.1/page
https://www.npmjs.org/package/chrome-rdebug
-->